/*
    Bu Modül Qwerty.R'ye Aittir Kodlar Çalınması Sonucu Gerekli İşlemler Yapılacakdır...
    Discord: https://discord.gg/pMRxGqaUtY​
    Discord Sunucumuza Gelmeyi Unutumayın!
    All rights reserved
    Copyright Qwerty.Lib
    Copyright Qwerty.R_Dev(oğuz kağan ayar)
*/

//=====================================================================
// modülüğn dayandıklarığ(depencies)
const Discord = require("discord.js");
const tebesir = require("chalk");
const FileSystem = require('fs');
//=====================================================================

//=====================================================================
// mesajlar
var başlamaZımbırtısı = tebesir.green.bold("Qwerty.L Başlatılıyor\nBip. Bop. Bip.");
var komutBulundu = tebesir.blue("Bulunan Komut: ");
var hata = tebesir.red.bold("Qwerty.L Hata: ");
//=====================================================================

module.exports = class {
    constructor(client, QwertylAyar){
        if(!client)throw new ReferenceError(hata + "Lütfen Clientı Belirtiniz");
        if(!QwertylAyar)throw new ReferenceError(hata + "Lütfen Ayarları Belirtiniz");
        if(!QwertylAyar.sahipId)throw new ReferenceError(hata + "Lütfen Sahipleri Belirtiniz");
        if(!QwertylAyar.prefix)throw new ReferenceError(hata + "Lütfen Prefixi Belirtiniz");
        if(!QwertylAyar.etiketlePrefixVer && QwertylAyar.etiketlePrefixVer !== false)throw new ReferenceError(hata + "Lütfen Etkietle Prefix Vermeyi Belirtiniz");
        if(!QwertylAyar.etiketlePrefixKullan && QwertylAyar.etiketlePrefixKullan !== false)throw new ReferenceError(hata + "Lütfen Etkietle Prefix Kullanı Belirtiniz");
        if(!QwertylAyar.botlarKullanabilsin && QwertylAyar.botlarKullanabilsin !== false)throw new ReferenceError(hata + "Lütfen Botların Komutları kullanabilip kulanamayacağını Belirtiniz");
        if(!QwertylAyar.komutKlasör)throw new ReferenceError(hata + "Lütfen Komut Klasörünüzü Belirtiniz");
        if(!QwertylAyar.eventKlasör)throw new ReferenceError(hata + "Lütfen Event Klasörünüzü Belirtiniz");
        if(!QwertylAyar.DMKabul && QwertylAyar.DMKabul !== false)throw new ReferenceError(hata + "Lütfen DM Kabul Edeyimmi? Belirtiniz");
        if(!QwertylAyar.KomutLog && QwertylAyar.KomutLog !== false)throw new ReferenceError(hata + "Lütfen KomutLog Sistemi Çalışsın mı? Belirtiniz");
        if(!QwertylAyar.komutBulamayıncaHata && QwertylAyar.komutBulamayıncaHata !== false)throw new ReferenceError(hata + "Lütfen Komut bulunamayınca Bulunamadı Yazayım mı? Belirtiniz");

        //=====================================================================
        // Qwerty.L Config Dosaysı Diğer Zımbırtı
        this.client = client;
        this.QwertylAyar
        //=====================================================================
        client.komutlar = new Discord.Collection();
        client.kestirme = new Map();
        require('./handlers/event.js')(client, QwertylAyar);
        
        console.log(başlamaZımbırtısı);
        var Komutlar = FileSystem.readdirSync(`${process.cwd()}/${QwertylAyar.komutKlasör}`).filter(dosya => dosya.endsWith('.js'));
        for(const dosya of Komutlar) {
          var komut = require(`${process.cwd()}/${QwertylAyar.komutKlasör}/${dosya}`);
          console.log(komutBulundu + tebesir.green.bold.underline(komut.isim))
          client.komutlar.set(komut.isim.toLowerCase(), komut);
        if(komut.kestirme && Array.isArray(komut.kestirme)) komut.kestirme.forEach(kisa => client.kestirme.set(kisa.toLowerCase(), komut.isim));
        }
        if(QwertylAyar.KomutLog){
          console.log(tebesir.yellow("Komut-Log Sistemş Aktifleştirildi!"));
        }
        console.log(tebesir.cyan.bold("Qwerty.L Kullandığınız İçin Sağolun!"));
    }
    mesaj(client, message, QwertylAyar){
        let pY = QwertylAyar.prefix;
        if(QwertylAyar.etiketlePrefixKullan) {
          pY = `<@!${client.user.id}>`
        }
        if(!QwertylAyar.botlarKullanabilsin) {
            if(message.author.bot) return;
        }
        if(QwertylAyar.etiketlePrefixVer) {
            if(message.content === `<@!${client.user.id}>`) return message.channel.send(`prefixim: **${QwertylAyar.prefix}**`)
        }
      if(message.content.startsWith(QwertylAyar.prefix)){
      if(message.webhookID || !message.content) return;
      if(!QwertylAyar.botlarKullanabilsin){
        if (message.author.bot) return;
      }
      if(message.channel.type === "dm"){
        if(!QwertylAyar.DMKabul || QwertylAyar.DMKabul == false) return
      }
      const args = message.content.slice(QwertylAyar.prefix.length).split(/ +/);
      const komut = args.shift().toLowerCase();
      let cmd;
      if(client.komutlar.has(komut)){
        cmd = client.komutlar.get(komut);
      } else if(client.kestirme.has(komut)){
        cmd = client.komutlar.get(client.kestirme.get(komut));
      }
      if(cmd){
        if(cmd.sahipOzel){
          if(QwertylAyar.sahipId[1] == undefined){
            if((QwertylAyar.sahipId[0]) !== message.author.id){
              const hataEmbed = new Discord.MessageEmbed()
                .setTitle('Bu Komut Botun Sahiplerine Özel!')
                .setDescription('Bu Komudu Kullanamazsın!')
                .setColor('RED')
                .setFooter(new Date().toLocaleString(), message.author.avatarURL());
              message.channel.send(hataEmbed);
            } else {
              try {
                cmd.calistir(client, message, args);
                if(QwertylAyar.KomutLog){
                  console.log(tebesir.red(`Konsol-Log | Bir Komut Kullanıldı`));
                  console.log(tebesir.greenBright(`Kullanılan Komut: ${cmd.isim}\nKullanan Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
                  if(QwertylAyar.KomutLog){
                    console.log(tebesir.red(`Konsol-Log | Bir Sahip Komudu Kullanılmaya Çalışıldı`));
                    console.log(tebesir.greenBright(`Komut: ${cmd.ism}\nYürüten Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
                  }
                }
              } catch (hata) {
                message.channel.send('bir hata oluştu');
                console.log(hata);
              }
            }
          } else if(QwertylAyar.sahipId[1] !== undefined){
            if(QwertylAyar.sahipId[0] == message.author.id || QwertylAyar.sahipId[1] == message.author.id){
              try {
                cmd.calistir(client, message, args);
                if(QwertylAyar.KomutLog){
                  console.log(tebesir.red(`Konsol-Log | Bir Komut Kullanıldı`));
                  console.log(tebesir.greenBright(`Kullanılan Komut: ${cmd.isim}\nKullanan Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
                }
              } catch (hata) {
                message.channel.send('bir hata oluştu');  
                console.log(hata);
              }
            } else {
              const hataEmbed = new Discord.MessageEmbed()
                .setTitle('Bu Komut Botun Sahiplerine Özel!')
                .setDescription('Bu Komudu Kullanamazsın!')
                .setColor('RED')
                .setFooter(new Date().toLocaleString(), message.author.avatarURL());
              message.channel.send(hataEmbed);
              if(QwertylAyar.KomutLog){
                console.log(tebesir.red(`Konsol-Log | Bir Sahip Komudu Kullanılmaya Çalışıldı`));
                console.log(tebesir.greenBright(`Komut: ${cmd.ism}\nYürüten Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
              }
            }
          }
        } else {
          cmd.calistir(client, message, args);
          if(QwertylAyar.KomutLog){
            console.log(tebesir.red(`Konsol-Log | Bir Komut Kullanıldı`));
            console.log(tebesir.greenBright(`Kullanılan Komut: ${cmd.isim}\nKullanan Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
          }
        } 
      } else {
        if(QwertylAyar.komutBulamayıncaHata){
          const hataEmbed = new Discord.MessageEmbed()
            .setTitle('Böyle Bir Komut Bulunamadı...')
            .setColor('RED')
            .setFooter(new Date().toLocaleString(), message.author.avatarURL());
          message.channel.send(hataEmbed);
          if(QwertylAyar.KomutLog){
            console.log(tebesir.red(`Konsol-Log | Bir Komut Bulunamadı`));
            console.log(tebesir.greenBright(`Bulunamayan Komut: ${komut}\nYürüten Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
          }
        }
      }
    } else if(message.content.startsWith(pY)){
      if(!QwertylAyar.botlarKullanabilsin){
        if (message.author.bot) return;
      }
      if(message.channel.type === "dm"){
        if(!QwertylAyar.DMKabul || QwertylAyar.DMKabul == false) return
      }
      const args = message.content.slice(pY.length).split(/ +/);
      const komut = args.shift().toLowerCase();
      let cmd;
      if(client.komutlar.has(komut)){
        cmd = client.komutlar.get(komut);
      } else if(client.kestirme.has(komut)){
        cmd = client.komutlar.get(client.kestirme.get(komut));
      }
      if(cmd){
        if(cmd.sahipOzel){
          if(QwertylAyar.sahipId[1] == undefined){
            if((QwertylAyar.sahipId[0]) !== message.author.id){
              const hataEmbed = new Discord.MessageEmbed()
                .setTitle('Bu Komut Botun Sahiplerine Özel!')
                .setDescription('Bu Komudu Kullanamazsın!')
                .setColor('RED')
                .setFooter(new Date().toLocaleString(), message.author.avatarURL());
              message.channel.send(hataEmbed);
            } else {
              try {
                cmd.calistir(client, message, args);
                if(QwertylAyar.KomutLog){
                  console.log(tebesir.red(`Konsol-Log | Bir Komut Kullanıldı`));
                  console.log(tebesir.greenBright(`Kullanılan Komut: ${cmd.isim}\nKullanan Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
                  if(QwertylAyar.KomutLog){
                    console.log(tebesir.red(`Konsol-Log | Bir Sahip Komudu Kullanılmaya Çalışıldı`));
                    console.log(tebesir.greenBright(`Komut: ${cmd.ism}\nYürüten Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
                  }
                }
              } catch (hata) {
                message.channel.send('bir hata oluştu');
                console.log(hata);
              }
            }
          } else if(QwertylAyar.sahipId[1] !== undefined){
            if(QwertylAyar.sahipId[0] == message.author.id || QwertylAyar.sahipId[1] == message.author.id){
              try {
                cmd.calistir(client, message, args);
                if(QwertylAyar.KomutLog){
                  console.log(tebesir.red(`Konsol-Log | Bir Komut Kullanıldı`));
                  console.log(tebesir.greenBright(`Kullanılan Komut: ${cmd.isim}\nKullanan Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
                }
              } catch (hata) {
                message.channel.send('bir hata oluştu');  
                console.log(hata);
              }
            } else {
              const hataEmbed = new Discord.MessageEmbed()
                .setTitle('Bu Komut Botun Sahiplerine Özel!')
                .setDescription('Bu Komudu Kullanamazsın!')
                .setColor('RED')
                .setFooter(new Date().toLocaleString(), message.author.avatarURL());
              message.channel.send(hataEmbed);
              if(QwertylAyar.KomutLog){
                console.log(tebesir.red(`Konsol-Log | Bir Sahip Komudu Kullanılmaya Çalışıldı`));
                console.log(tebesir.greenBright(`Komut: ${cmd.ism}\nYürüten Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
              }
            }
          }
        } else {
          cmd.calistir(client, message, args);
          if(QwertylAyar.KomutLog){
            console.log(tebesir.red(`Konsol-Log | Bir Komut Kullanıldı`));
            console.log(tebesir.greenBright(`Kullanılan Komut: ${cmd.isim}\nKullanan Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
          }
        } 
      } else {
        if(QwertylAyar.komutBulamayıncaHata){
          const hataEmbed = new Discord.MessageEmbed()
            .setTitle('Böyle Bir Komut Bulunamadı...')
            .setColor('RED')
            .setFooter(new Date().toLocaleString(), message.author.avatarURL());
          message.channel.send(hataEmbed);
          if(QwertylAyar.KomutLog){
            console.log(tebesir.red(`Konsol-Log | Bir Komut Bulunamadı`));
            console.log(tebesir.greenBright(`Bulunamayan Komut: ${komut}\nYürüten Kişi: ${message.author.tag}\nKişi İd: ${message.author.id}`))
          }
        }
      }
    }
  }
}